<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Participants - Crescat Entitlement System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: hsl(204, 77%, 12%);
      --bg-sidebar: hsl(205, 64%, 14%);
      --bg-content: hsl(204, 77%, 12%);
      --bg-hover: hsl(205, 57%, 16%);
      --bg-active: hsl(205, 47%, 19%);
      --bg-input: hsl(205, 68%, 14%);
      --bg-row: hsl(204, 77%, 12%);
      --bg-row-alt: hsl(205, 64%, 14%);
      --bg-row-hover: hsl(205, 57%, 16%);
      --text-default: hsl(205, 42%, 84%);
      --text-soft: hsl(205, 16%, 57%);
      --text-inverted: hsl(204, 77%, 12%);
      --text-link: hsl(203, 90%, 48%);
      --border-default: hsl(203, 44%, 20%);
      --border-soft: hsl(204, 52%, 17%);
      --color-success: hsl(151, 61%, 43%);
      --color-primary: hsl(205, 69%, 33%);
      --color-pending: hsl(44, 88%, 66%);
      --color-warning: hsl(0, 88%, 66%);
      --color-highlight: #45A4E4;
    }
    body { background: var(--bg-main); color: var(--text-default); font-family: 'Inter', sans-serif; font-size: 14px; }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
    ::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-soft); }

    .sidebar-link {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 16px; border-radius: 6px;
      color: var(--text-soft); font-size: 13px; font-weight: 500;
      text-decoration: none; transition: all 0.15s;
    }
    .sidebar-link:hover { background: var(--bg-hover); color: var(--text-default); }
    .sidebar-link.active { background: var(--bg-active); color: var(--text-default); }

    .badge {
      display: inline-flex; align-items: center;
      padding: 2px 10px; border-radius: 9999px;
      font-size: 12px; font-weight: 500; line-height: 20px;
    }
    .badge-success { background: hsla(151, 61%, 43%, 0.1); border: 1px solid hsla(151, 61%, 43%, 0.2); color: var(--color-success); }
    .badge-warning { background: hsla(0, 88%, 66%, 0.1); border: 1px solid hsla(0, 88%, 66%, 0.2); color: var(--color-warning); }
    .badge-pending { background: hsla(44, 88%, 66%, 0.1); border: 1px solid hsla(44, 88%, 66%, 0.2); color: var(--color-pending); }
    .badge-info { background: rgba(69, 164, 228, 0.1); border: 1px solid rgba(69, 164, 228, 0.2); color: var(--color-highlight); }
    .badge-crew { background: hsla(205, 69%, 33%, 0.15); border: 1px solid hsla(205, 69%, 33%, 0.3); color: #5BA3D9; }
    .badge-guest { background: hsla(280, 60%, 55%, 0.1); border: 1px solid hsla(280, 60%, 55%, 0.2); color: hsl(280, 60%, 65%); }
    .badge-responder { background: hsla(151, 61%, 43%, 0.1); border: 1px solid hsla(151, 61%, 43%, 0.2); color: var(--color-success); }
    .badge-travel { background: hsla(44, 88%, 66%, 0.1); border: 1px solid hsla(44, 88%, 66%, 0.2); color: var(--color-pending); }

    .card {
      background: var(--bg-content);
      border: 1px solid var(--border-default);
      border-radius: 6px;
    }

    .data-table { width: 100%; border-collapse: collapse; }
    .data-table thead th {
      position: sticky; top: 0; z-index: 5;
      background: var(--bg-sidebar);
      padding: 10px 16px; text-align: left;
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.05em; color: var(--text-soft);
      border-bottom: 1px solid var(--border-default);
    }
    .data-table tbody tr:nth-child(odd) { background: var(--bg-row); }
    .data-table tbody tr:nth-child(even) { background: var(--bg-row-alt); }
    .data-table tbody tr:hover { background: var(--bg-row-hover); cursor: pointer; }
    .data-table td {
      padding: 10px 16px; font-size: 13px;
      border-bottom: 1px solid var(--border-soft);
    }

    .filter-input {
      background: var(--bg-input);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      color: var(--text-default);
      padding: 0 12px;
      height: 30px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: border-color 0.15s;
    }
    .filter-input:focus { border-color: var(--color-primary); }
    .filter-input::placeholder { color: var(--text-soft); }

    .btn-primary {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 0 16px; height: 30px; border-radius: 6px;
      background: var(--color-primary); color: white;
      font-size: 13px; font-weight: 500; text-transform: capitalize;
      border: none; cursor: pointer; white-space: nowrap;
    }
    .btn-primary:hover { filter: brightness(1.1); }

    .btn-ghost {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 0 12px; height: 30px; border-radius: 6px;
      background: transparent; color: var(--text-soft);
      font-size: 13px; font-weight: 500;
      border: 1px solid var(--border-default); cursor: pointer; white-space: nowrap;
    }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-default); }

    .avatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 600; color: white; flex-shrink: 0;
    }

    .action-btn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 26px; height: 26px; border-radius: 3px;
      color: var(--text-soft); cursor: pointer; transition: all 0.15s;
    }
    .action-btn:hover { background: var(--bg-hover); color: var(--text-default); }
  </style>
</head>
<body class="min-h-screen" x-data="{
  participants: [],
  meta: { total: 0, page: 1, per_page: 10, last_page: 1 },
  loading: true,
  filterSearch: '',
  filterType: 'All',
  filterStatus: 'All',
  sortField: 'name',
  currentPage: 1,
  perPage: 10,
  helpOpen: false,
  selectedRows: [],
  showAddParticipant: false,
  newParticipant: {name:'', email:'', type:'crew', affiliation:'', role:''},
  confirmAction: null,
  toast: null,
  searchTimeout: null,

  init() { this.load() },

  async load() {
    this.loading = true;
    const p = new URLSearchParams();
    p.set('page', this.currentPage);
    p.set('per_page', this.perPage);
    p.set('sort', this.sortField);
    if (this.filterSearch) p.set('name_like', '%' + this.filterSearch + '%');
    if (this.filterType !== 'All') p.set('participant_type', this.filterType.toLowerCase().replace(' ', '_'));
    if (this.filterStatus !== 'All') p.set('status', this.filterStatus.toLowerCase());
    const res = await fetch('/api/participants?' + p.toString());
    const json = await res.json();
    this.participants = json.data;
    this.meta = json.meta;
    this.loading = false;
  },

  debouncedLoad() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => { this.currentPage = 1; this.load(); }, 300);
  },

  sort(field) {
    this.sortField = this.sortField === field ? '-' + field : field;
    this.currentPage = 1;
    this.load();
  },

  async addParticipant() {
    if (!this.newParticipant.name.trim() || !this.newParticipant.email.trim()) return;
    await fetch('/api/participants', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: this.newParticipant.name.trim(),
        email: this.newParticipant.email.trim(),
        participant_type: this.newParticipant.type,
        affiliation: this.newParticipant.affiliation.trim() || null,
        role: this.newParticipant.role.trim() || null
      })
    });
    this.newParticipant = {name:'', email:'', type:'crew', affiliation:'', role:''};
    this.showAddParticipant = false;
    this.showToast('Participant added successfully');
    await this.load();
  },

  async scrambleEmail(p) {
    await fetch('/api/participants/' + p.id + '/scramble-email', { method: 'POST' });
    this.showToast('Email scrambled for ' + p.name);
    await this.load();
  },

  async toggleStatus(p) {
    const newStatus = p.status === 'active' ? 'suspended' : 'active';
    await fetch('/api/participants/' + p.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    this.showToast(p.name + (newStatus === 'suspended' ? ' suspended' : ' reactivated'));
    await this.load();
  },

  setFilter(field, value) {
    this[field] = value;
    this.currentPage = 1;
    this.load();
  },

  clearFilters() {
    this.filterSearch = '';
    this.filterType = 'All';
    this.filterStatus = 'All';
    this.currentPage = 1;
    this.load();
  },

  initials(name) {
    const parts = name.trim().split(/\s+/);
    return parts.length >= 2 ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() : parts[0].substring(0,2).toUpperCase();
  },

  avatarColor(id) {
    const colors = ['#2E7D9C','#7B5EA7','#D4783A','#3A8D5C','#C7534D'];
    return colors[id % colors.length];
  },

  badgeClass(type) {
    const map = {crew:'badge-crew', responder:'badge-responder', travel_party:'badge-travel', guest:'badge-guest'};
    return map[type] || 'badge-crew';
  },

  typeLabel(type) {
    const map = {crew:'Crew', responder:'Responder', travel_party:'Travel Party', guest:'Guest'};
    return map[type] || type;
  },

  statusBadge(status) {
    const map = {active:'badge-success', suspended:'badge-pending', revoked:'badge-warning'};
    return map[status] || 'badge-info';
  },

  showToast(msg) {
    this.toast = msg;
    setTimeout(() => this.toast = null, 3000);
  },

  get totalPages() { return this.meta.last_page || 1; },
  get showingFrom() { return ((this.currentPage - 1) * this.perPage) + 1; },
  get showingTo() { return Math.min(this.currentPage * this.perPage, this.meta.total); }
}">

  <!-- TOP NAVBAR -->
  <nav class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-4" style="height: 48px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border-default);">
    <div class="flex items-center gap-4">
      <img src="https://crescat.io/assets/logo/logo-white.svg" alt="Crescat" style="height: 12px;">
      <span style="color: var(--text-soft);">|</span>
      <span style="color: var(--text-soft); font-size: 13px;">Midgard Festival 2026</span>
    </div>
    <div class="flex items-center gap-3">
      <span style="color: var(--text-soft); font-size: 13px;">Admin</span>
      <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold" style="background: var(--color-primary); color: #fff;">JD</div>
    </div>
  </nav>

  <!-- SIDEBAR -->
  <aside class="fixed top-12 left-0 bottom-0 overflow-y-auto py-4 px-3" style="width:232px; background:var(--bg-sidebar); border-right:1px solid var(--border-default);">
    <div class="mb-4 px-3">
      <p class="text-xs font-semibold uppercase tracking-wider mb-2" style="color:var(--text-soft);">Main</p>
    </div>
    <nav class="flex flex-col gap-1">
      <a href="01-dashboard.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </a>
      <a href="02-participants.html" class="sidebar-link active">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        Participants
      </a>
      <a href="04-entitlement-items.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
        Entitlement Items
      </a>
      <a href="05-rules.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Rules Engine
      </a>
      <a href="06-zones.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/></svg>
        Zones
      </a>
      <a href="07-checkpoints.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0112 2a8 8 0 018 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
        Checkpoints
      </a>
      <a href="08-allocations.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
        Allocations
      </a>
      <a href="09-credentials.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Credentials
      </a>
      <a href="10-scan-log.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Scan Log
      </a>
      <a href="13-schedules.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Schedules
      </a>
      <a href="14-equipment.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
        Equipment
      </a>
      <a href="catering.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
        Catering
      </a>
      <a href="lost-found.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Lost &amp; Found
      </a>
      <a href="crowd-flow.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/><polyline points="22 4 22 10 16 10"/></svg>
        Crowd Flow
      </a>

      <div class="my-3 mx-3" style="border-top:1px solid var(--border-soft);"></div>
      <p class="text-xs font-semibold uppercase tracking-wider mb-2 px-3" style="color:var(--text-soft);">On-Site</p>

      <a href="11-scanner.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h3"/><path d="M20 7V4h-3"/><path d="M4 17v3h3"/><path d="M20 17v3h-3"/><line x1="4" y1="12" x2="20" y2="12"/></svg>
        Scanner
      </a>
      <a href="12-accreditation-office.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        Accreditation Office
      </a>

      <div class="my-3 mx-3" style="border-top:1px solid var(--border-soft);"></div>
      <p class="text-xs font-semibold uppercase tracking-wider mb-2 px-3" style="color:var(--text-soft);">Self-Service</p>

      <a href="volunteer-onboarding.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
        Volunteer Portal
      </a>
      <a href="15-portal.html" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8"/><path d="M12 17v4"/></svg>
        Self-Service Portal
      </a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="pt-12" style="margin-left:232px;">
    <div class="p-8">
      <!-- Page Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-xl font-bold mb-1" style="color:var(--text-default);">Participants</h1>
          <p class="text-sm" style="color:var(--text-soft);">Manage all participants in the Midgard Festival 2026 entitlement system</p>
        </div>
        <div class="flex items-center gap-3">
          <button class="btn-ghost" @click="showToast('Import feature coming soon')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Import
          </button>
          <button class="btn-primary" @click="showAddParticipant = true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Participant
          </button>
        </div>
      </div>

      <!-- FILTER BAR -->
      <div class="card p-4 mb-4">
        <div class="flex items-center gap-3 flex-wrap">
          <!-- Search -->
          <div class="relative flex-1 min-w-[240px]">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-soft)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" placeholder="Search participants by name..." class="filter-input w-full pl-9" x-model="filterSearch" @input="debouncedLoad()">
          </div>

          <!-- Type Filter -->
          <div x-data="{ open: false }" class="relative">
            <button @click="open = !open" class="filter-input flex items-center gap-2 cursor-pointer" style="width:150px;">
              <span x-text="filterType" class="flex-1 text-left"></span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div x-show="open" @click.away="open = false" x-transition class="absolute top-full left-0 mt-1 w-full rounded-md shadow-lg z-20" style="background:var(--bg-sidebar); border:1px solid var(--border-default);">
              <template x-for="type in ['All', 'Crew', 'Responder', 'Travel Party', 'Guest']">
                <button @click="setFilter('filterType', type); open = false" class="block w-full text-left px-3 py-2 text-sm hover:bg-[var(--bg-hover)]" style="color:var(--text-default);" x-text="type"></button>
              </template>
            </div>
          </div>

          <!-- Status Filter -->
          <div x-data="{ open: false }" class="relative">
            <button @click="open = !open" class="filter-input flex items-center gap-2 cursor-pointer" style="width:130px;">
              <span x-text="filterStatus" class="flex-1 text-left"></span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div x-show="open" @click.away="open = false" x-transition class="absolute top-full left-0 mt-1 w-full rounded-md shadow-lg z-20" style="background:var(--bg-sidebar); border:1px solid var(--border-default);">
              <template x-for="status in ['All', 'Active', 'Suspended', 'Revoked']">
                <button @click="setFilter('filterStatus', status); open = false" class="block w-full text-left px-3 py-2 text-sm hover:bg-[var(--bg-hover)]" style="color:var(--text-default);" x-text="status"></button>
              </template>
            </div>
          </div>

          <button class="btn-ghost text-xs" style="color:var(--color-highlight);" @click="clearFilters()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            Clear
          </button>
        </div>
      </div>

      <!-- BULK ACTIONS BAR -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <span class="text-sm" style="color:var(--text-soft);" x-text="meta.total + ' participants'"></span>
          <span style="color:var(--border-default);">&#183;</span>
          <span class="text-sm" style="color:var(--text-soft);" x-text="'Showing ' + showingFrom + '-' + showingTo"></span>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn-ghost text-xs">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
            Assign Entitlement
          </button>
          <button class="btn-ghost text-xs">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Print Badges
          </button>
          <button class="btn-ghost text-xs">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
          </button>
        </div>
      </div>

      <!-- PARTICIPANTS TABLE -->
      <div class="card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width:36px;">
                  <input type="checkbox" class="rounded" style="accent-color:var(--color-primary);"
                    @click="selectedRows = $event.target.checked ? participants.map(p => p.id) : []"
                    :checked="selectedRows.length === participants.length && selectedRows.length > 0">
                </th>
                <th @click="sort('name')" class="cursor-pointer">Participant <span x-show="sortField === 'name'">&#8593;</span><span x-show="sortField === '-name'">&#8595;</span></th>
                <th @click="sort('participant_type')" class="cursor-pointer">Type <span x-show="sortField === 'participant_type'">&#8593;</span><span x-show="sortField === '-participant_type'">&#8595;</span></th>
                <th @click="sort('affiliation')" class="cursor-pointer">Affiliation <span x-show="sortField === 'affiliation'">&#8593;</span><span x-show="sortField === '-affiliation'">&#8595;</span></th>
                <th>Role</th>
                <th>Entitlements</th>
                <th>Credentials</th>
                <th @click="sort('status')" class="cursor-pointer">Status <span x-show="sortField === 'status'">&#8593;</span><span x-show="sortField === '-status'">&#8595;</span></th>
                <th style="width:100px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="p in participants" :key="p.id">
                <tr @click="window.location='03-participant-detail.html'">
                  <td><input type="checkbox" style="accent-color:var(--color-primary);" @click.stop :checked="selectedRows.includes(p.id)" @change="selectedRows.includes(p.id) ? selectedRows = selectedRows.filter(i => i !== p.id) : selectedRows.push(p.id)"></td>
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="avatar" :style="'background:' + avatarColor(p.id)" x-text="initials(p.name)"></div>
                      <div>
                        <p class="font-medium" style="color:var(--text-default);" x-text="p.name"></p>
                        <p class="text-xs" style="color:var(--text-soft);" x-text="p.email"></p>
                      </div>
                    </div>
                  </td>
                  <td><span class="badge" :class="badgeClass(p.participant_type)" x-text="typeLabel(p.participant_type)"></span></td>
                  <td style="color:var(--text-default);" x-text="p.affiliation || '\u2014'"></td>
                  <td style="color:var(--text-soft);" x-text="p.role || '\u2014'"></td>
                  <td><span class="badge badge-info">\u2014</span></td>
                  <td><span class="badge badge-info">\u2014</span></td>
                  <td><span class="badge" :class="statusBadge(p.status)" x-text="p.status" style="text-transform:capitalize;"></span></td>
                  <td>
                    <div class="flex items-center gap-1">
                      <a href="03-participant-detail.html" class="action-btn" title="View" @click.stop><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></a>
                      <button class="action-btn" title="Scramble Email" @click.stop="scrambleEmail(p)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                      <button class="action-btn" :title="p.status === 'active' ? 'Suspend' : 'Reactivate'" :style="p.status === 'active' ? 'color:var(--color-warning);' : 'color:var(--color-success);'" @click.stop="confirmAction = {title: p.status === 'active' ? 'Suspend Participant' : 'Reactivate Participant', message: 'Are you sure you want to ' + (p.status === 'active' ? 'suspend' : 'reactivate') + ' ' + p.name + '?', action: () => toggleStatus(p)}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PAGINATION -->
      <div class="flex items-center justify-between mt-4">
        <p class="text-sm" style="color:var(--text-soft);" x-text="'Showing ' + showingFrom + ' to ' + showingTo + ' of ' + meta.total + ' participants'"></p>
        <div class="flex items-center gap-1">
          <button class="btn-ghost text-xs" @click="if(currentPage > 1) { currentPage--; load(); }" :disabled="currentPage <= 1" :style="currentPage <= 1 ? 'opacity:0.4' : ''">&#8592; Previous</button>
          <template x-for="pg in totalPages" :key="pg">
            <button class="flex items-center justify-center text-xs font-medium" @click="currentPage = pg; load()"
              :style="currentPage === pg ? 'width:30px; height:30px; border-radius:6px; background:var(--color-primary); color:white;' : 'width:30px; height:30px; border-radius:6px; background:var(--bg-input); color:var(--text-soft); border:1px solid var(--border-default);'" x-text="pg"></button>
          </template>
          <button class="btn-ghost text-xs" @click="if(currentPage < totalPages) { currentPage++; load(); }" :disabled="currentPage >= totalPages" :style="currentPage >= totalPages ? 'opacity:0.4' : ''">Next &#8594;</button>
        </div>
      </div>
    </div>
  </main>

  <!-- HELP OVERLAY BUTTON -->
  <button @click="helpOpen = true"
    class="fixed bottom-6 right-6 w-10 h-10 rounded-full flex items-center justify-center shadow-lg z-50 text-white font-bold text-lg"
    style="background:var(--color-primary);">
    ?
  </button>

  <!-- HELP MODAL -->
  <div x-show="helpOpen" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(0,0,0,0.6);">
    <div @click.away="helpOpen = false" class="w-full max-w-lg rounded-lg p-6" style="background:var(--bg-sidebar); border:1px solid var(--border-default);">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold" style="color:var(--text-default);">About this Screen</h2>
        <button @click="helpOpen = false" class="text-lg" style="color:var(--text-soft);">&#10005;</button>
      </div>
      <div class="space-y-3 text-sm" style="color:var(--text-default); line-height:1.6;">
        <p><strong>What is this screen for?</strong></p>
        <p>The Participants screen is the master list of everyone in the entitlement system. Each person has one Participant record per festival, regardless of how many roles they have. Use filters to find specific participants and bulk actions to manage entitlements.</p>
        <p><strong>Workflow Coverage</strong></p>
        <p>This covers the Participant Onboarding workflow from the proposal. Participants are created from external sources (forms, imports, travel party management) and appear here once they are in the system.</p>
        <p><strong>Key Interactions</strong></p>
        <ul class="list-disc pl-5 space-y-1" style="color:var(--text-soft);">
          <li>Search and filter participants by type, status, entitlement, and section</li>
          <li>Use bulk actions to assign entitlements, print badges, or export data</li>
          <li>Click any row to view the full participant detail</li>
          <li>Use action buttons to view, edit, or revoke individual participants</li>
          <li>Import participants from CSV or external systems</li>
          <li>Add new participants manually</li>
        </ul>
      </div>
      <button @click="helpOpen = false" class="mt-5 w-full flex items-center justify-center font-medium capitalize"
        style="height:38px; background:var(--color-primary); color:white; border-radius:6px; font-size:14px;">
        Got it
      </button>
    </div>
  </div>

  <!-- ADD PARTICIPANT MODAL -->
  <div x-show="showAddParticipant" x-transition.opacity class="fixed inset-0 z-[60] flex items-center justify-center" style="background:rgba(0,0,0,0.6);">
    <div @click.stop class="w-full max-w-md rounded-lg p-6" style="background:var(--bg-sidebar); border:1px solid var(--border-default);">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-base font-bold" style="color:var(--text-default);">Add Participant</h2>
        <button @click="showAddParticipant = false" class="text-lg" style="color:var(--text-soft);">&#10005;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:var(--text-soft);">Full Name *</label>
          <input type="text" x-model="newParticipant.name" placeholder="e.g. John Doe" class="filter-input w-full" style="height:38px;">
        </div>
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:var(--text-soft);">Email *</label>
          <input type="email" x-model="newParticipant.email" placeholder="e.g. john@example.com" class="filter-input w-full" style="height:38px;">
        </div>
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:var(--text-soft);">Type</label>
          <select x-model="newParticipant.type" class="filter-input w-full" style="height:38px;">
            <option value="crew">Crew</option>
            <option value="responder">Responder</option>
            <option value="travel_party">Travel Party</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:var(--text-soft);">Affiliation</label>
          <input type="text" x-model="newParticipant.affiliation" placeholder="e.g. Sound Department" class="filter-input w-full" style="height:38px;">
        </div>
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:var(--text-soft);">Role</label>
          <input type="text" x-model="newParticipant.role" placeholder="e.g. Stage Manager" class="filter-input w-full" style="height:38px;">
        </div>
      </div>
      <div class="flex items-center justify-end gap-3 mt-6">
        <button @click="showAddParticipant = false" class="btn-ghost">Cancel</button>
        <button @click="addParticipant()" class="btn-primary" style="height:38px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Participant
        </button>
      </div>
    </div>
  </div>

  <!-- CONFIRMATION MODAL -->
  <div x-show="confirmAction" x-transition.opacity class="fixed inset-0 z-[60] flex items-center justify-center" style="background:rgba(0,0,0,0.6);">
    <div @click.stop class="w-full max-w-sm rounded-lg p-6" style="background:var(--bg-sidebar); border:1px solid var(--border-default);">
      <h3 class="font-semibold mb-2" style="color:var(--text-default);" x-text="confirmAction?.title"></h3>
      <p class="text-sm mb-4" style="color:var(--text-soft);" x-text="confirmAction?.message"></p>
      <div class="flex justify-end gap-2">
        <button class="btn-ghost" @click="confirmAction = null">Cancel</button>
        <button class="btn-primary" style="background:var(--color-warning);" @click="confirmAction?.action(); confirmAction = null">Confirm</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div x-show="toast" x-transition class="fixed top-16 right-6 z-[70] px-4 py-2 rounded-md text-sm font-medium" style="background:var(--color-primary); color:white;" x-text="toast"></div>

</body>
</html>
